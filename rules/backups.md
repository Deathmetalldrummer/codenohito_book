Правила сбора и хранения бэкапов
================================

Хранение
--------

В корне директории, предназначенной для хранения бэкапа есть две директории: projects и logs.

В директории projects вложенные директории называются по названию проектов, которые мы бэкапим.
В каждой директории проекта бэкапы располагаются в папках, содержащих дату и время снятия бэкапа в формате 'YYYYmmddHHMM'.
Например, '/projects/costabella/201607181459/'.
Указывать дату вместе со временем необходимо для случая, когда в день снимаем несколько бэкапов.
Допустимо грубое округление времени до десятка минут или указания времени 0000, если неизвестно в какой время был снят бэкап.

    projects
      costabella
        201605151548 - backup files here
        201606011211 - backup files here
      ledmaster
        201606011258 - backup files here
        201606161321 - backup files here
        201607020912 - backup files here
      kims
        201512230000 - backup files here
        201607181434 - backup files here

В директории logs храним логи проектов.
В ней так же вложены директории по названиям проектов, но на директории с датами они не разбиты.
Внутри директории проекта непосредственно лежат архивы с логами проекта с указанием даты времени в названии.

    logs
      costabella - backup files here
      ledmaster  - backup files here
      kims       - backup files here

Бэкап рядовой
-------------

Рядовой сбор бэкапа проекта проходит по графику бэкапов и содержит в себе:

* дамп базы данных в формате sql (или любом другом подходящем, если есть необходимость);
* архив с загруженными файлами, папка uploads, например (tar.gz или zip);
* архив с файлом лога;

---

Файл дампа базы данных должен содержать в названии её название и дату сбора в формате 'dbname.YYYYmmdd.sql'.
Например, 'costabella_prod.20160718.sql'.
Снять дамп с PostgreSQL можно командой:

    pg_dump --no-owner > dbname.YYYYmmdd.sql

Или, если имя пользователя в системе не совпадает с именем владельца базы данных:

    pg_dump --no-owner --username=username --password dbname > dbname.YYYYmmdd.sql

Дамп MySQL базы данных снимается командой:

    mysqldump -u user_name -p dbname > dbname.YYYYmmdd.sql

---

Файл архива загруженных файлов должен создержать в названии название проекта, папки, которую содержит и даты сбора.
В формате 'project.uploads_dir.YYYYmmdd.arc_ext'.
Например, 'costabella.uploads.20160718.tar.gz' или 'kims.system.20151123.zip'.
Если загруженные файлы хранятся с нескольких директориях одной папки, то можно указать их родительскую папку.
Например, если у Крафтапа загруженные файлы хранятся в директориях 'public/uploads' и 'public/more_uploads',
то архив можно назвать 'craftup.public.20160131.tag.gz'.

Шпаргалка по сбору архива загруженных файлов:

    cd www/project/shared/public
    tar czvpf project.uploads.YYYYmmdd.tar.gz uploads

---

При рядовом сборе бэкапа нужно сделать архив файла лога и очистить его.
Файл архива должен содержать название проекта, надпись log и дату и время сбора.
В формате 'project.log.YYYYmmddHHMM.arc_ext'.
Например, 'costabella.log.201607181520.tar.gz'.

Шпаргалка по собру архива лога и его последующей очистки:

    cd www/project/shared/log
    tar czvpf project.log.YYYYmmddHHMM.tar.gz production.log
    cat /dev/null > production.log

---

Все дампы у нас помещаются на бэкап-сервер (Яндекс.Диск, в нашем случае).

Файлы дампа и архива загруженных файлов должны быть помещены в '/projects/\[название проекта\]/\[дата и время бэкапа с допустимым округлением до 10 минут\]'.

Файл архива лога должен быть помещен в '/logs/\[название проекта\]'.


Бэкап итоговый
--------------

Итоговый сбор бэкапа делается в случае, если его нужно передать клиенту при закрытии проекта или просто клиент попросил весь его проект ему скинуть.
Главное отличие от рядового бэкапа в том, что тут следует собрать в архив не только загруженные файлы, но и код проекта и статичные content файлы и сиды.

Собираем архив проекта, который представляет собой всю корневую директорию проекта со всеми файлами, в том числе загруженными, но без содержания папки tmp.
Формат названия файла: 'project.YYYYmmdd.tar.gz'.

Также собираем дамп базы данных точно так же как в рядовом бэкапе.

Файлы итогового бэкапа размещаются там же где и файлы рядового: '/projects/\[название проекта\]/\[дата и время сбора бэкапа с допустимым округлением до 10 минут\]'.

В случае итогового бэкапа лог отдельно не бэкапится.
