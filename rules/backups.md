Правила сбора и хранения бэкапов
================================

Краткий пример файловой структуры бэкапов
-----------------------------------------

    projects
      costabella
        201605151548
          costabella.201605151548.db.sql
          costabella.201605151548.uploads.tar.gz
        201606011211
          costabella.201606011211.db.sql
          costabella.201606011211.uploads.tar.gz
      ledmaster
        201606011258
          ledmaster.201606011258.db_dump.sql
          ledmaster.201606011258.uploads.tar.gz
        201606161321_full
          ledmaster.201606161321.code_repo.zip
          ledmaster.201606161321.content_n_seeds.zip
          ledmaster.201606161321.db_dump.sql
          ledmaster.201606161321.uploads.tar.gz
        201607020912
          ledmaster.201607020912.db_dump.sql
          ledmaster.201607020912.uploads.tar.gz
      kims
        201512232359
          kims.201512232359.db.sql
          kims.201512232359.system.tar.gz
          kims.201512232359.uploads.tar.gz
    logs
      costabella
        costabella.201605151548.log.tar.gz
        costabella.201606011211.log.tar.gz
      ledmaster
        ledmaster.201606011258.log.tar.gz
        ledmaster.201606161321.log.tar.gz
        ledmaster.201607020912.log.tar.gz
      kims
        kims.201512232359.log.tar.gz


Хранение
--------

В корне директории, предназначенной для хранения бэкапа есть две директории:
projects и logs. Директория logs предназначена для хранения исключительно логов
проектов, а projects — для всего остального.

В директории projects вложенные директории называются по названию проектов,
которые мы бэкапим.
В каждой директории проекта бэкапы располагаются в папках, содержащих дату
и время снятия бэкапа в формате 'YYYYmmddHHMM'.
Например, '/projects/costabella/201607181459/'.
Указывать дату вместе со временем необходимо для случая, когда в день снимаем
несколько бэкапов.
Допустимо грубое округление времени до десятка минут или указания времени 2359,
если неизвестно в какой время был снят бэкап.
Можно дописать краткий комментарий к имени директории, например директорию с
полным бэкапом назвать '201610311245_full'.

В директории logs храним логи проектов.
В ней так же вложены директории по названиям проектов, но на директории
с датами они не разбиты.
Внутри директории проекта непосредственно лежат архивы с логами проекта
с указанием даты и времени в названии.

Все файлы бэкапов получают единообразное имя следующей структуры:

    [project_name].[YYYYmmddHHMM].[content_type].[ext]

* 'project_name' — название проекта;
* 'YYYYmmddHHMM' - дата и время сбора этого файла бэкапа
  (можно проигнорировать 'HHMM', но не рекомендуется);
* 'content_type' — названия вида данных в этом файле бэкапа в свободном формате,
  но понятно, например: 'db' или 'db_dump' для дампа базы данных, 'uploads'
  для загруженных файлов, 'code' для архива с кодом проекта, 'log'
  для архива лога приложения и пр.;
* 'ext' — расширение файла (sql для дампа, zip или tar.gz для архива и т.п.);

В имени файла все эти части разделены точками. Примеры есть выше.


Виды бэкапов и требования к ним
-------------------------------

### Бэкап рядовой

Рядовой сбор бэкапа проекта проходит по графику бэкапов и содержит в себе:

* дамп базы данных;
* архив с загруженными файлами (папка uploads, например);
* архив с файлом лога;


### Бэкап итоговый

Итоговый сбор бэкапа делается в случае, если его нужно передать клиенту
при закрытии проекта или просто клиент попросил весь его проект ему скинуть.
Главное отличие от рядового бэкапа в том, что тут следует собрать в архив
не только загруженные файлы, но и код проекта и статичные content файлы и сиды.
Архив с логом клиенту не передаётся, но собрать его не будет лишним.

Для итогового бэкапа, который будет передан клиенту, допустимо помещение всех
собранных файлов в один архив с именем формата
`[project_name].[YYYYmmddHHMM].[ext]` (без указания вида данных).


Helpers
-------

### Сбор дампа базы данных

Снять дамп с PostgreSQL можно командой:

    pg_dump --no-owner [database_name] > [project_name].[YYYYmmddHHMM].db.sql

Если имя пользователя в системе не совпадает с именем владельца базы данных:

    pg_dump --no-owner --username=[username] --password [database_name] > [project_name].[YYYYmmddHHMM].db.sql

Дамп MySQL базы данных снимается командой:

    mysqldump -u [user_name] -p [database_name] > [project_name].[YYYYmmddHHMM].db.sql


### Архив загруженных файлов

    cd www/[project_name]/shared/public
    tar czvpf [project_name].[YYYYmmddHHMM].uploads.tar.gz uploads


### Архив лога

После сбора бэкапа файла лога рекомендуется его очищать.
Если во время архивации лог будет обновлён, архивация завалится. Так что сначала
перемещаем файл лога, поставив на его место чистый, и только потом архивим.

    cd www/[project_name]/shared/log
    mv production.log ~/
    cat /dev/null > production.log
    cd ~/
    tar czvpf [project_name].[YYYYmmddHHMM].log.tar.gz production.log
    rm production.log
